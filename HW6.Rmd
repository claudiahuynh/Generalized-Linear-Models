---
title: "HW6"
author: "My An Huynh"
date: "2024-11-19"
output: github_document
---

```{r}
library(tidyverse)
library(p8105.datasets)
library(modelr)
library(mgcv)
library(SemiPar)
library(glmnet)
```

## Problem 1
```{r}
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2017-01-01",
    date_max = "2017-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())
```

## Problem 2
```{r data wrangling}
homicide_df =
  read_csv("data/homicide-data.csv") |> 
  mutate(
    city_state = paste(city, state, sep = ", "),
    solved_bin = ifelse(disposition == "Closed by arrest", 1, 0),
    victim_age = as.numeric(victim_age)
  ) |>
  filter(
    !(city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL")),
    victim_race %in% c("White", "Black")
  ) |> 
  select(-city, -state)


```

Glm for Baltimore, MD
```{r}
baltimore = 
  homicide_df |> 
  filter(
    city_state == "Baltimore, MD"
  ) 

baltimore_glm = 
  glm(solved_bin ~ victim_age + victim_race + victim_sex, data = baltimore, family = binomial()) |> 
  broom::tidy() |> 
  filter(
    term == "victim_sexMale"
  ) |> 
  mutate(
    odds_ratio = exp(estimate),
    conf_upper_95 = exp(estimate + 1.96 * std.error),
    conf_lower_95 = exp(estimate - 1.96 * std.error)
  )
```

Do this for every city 

```{r}
glm_function = function(df) {
  df = 
    glm(solved_bin ~ victim_age + victim_race + victim_sex, data = df, family = binomial()) |> 
    broom::tidy() |> 
    filter(
      term == "victim_sexMale"
    ) |> 
    mutate(
      odds_ratio = exp(estimate),
      conf_upper_95 = exp(estimate + 1.96 * std.error),
      conf_lower_95 = exp(estimate - 1.96 * std.error)
    )
}

homicide_glm = 
  homicide_df |> 
  select(city_state, solved_bin, victim_sex, victim_age, victim_race) |>
  nest(data = solved_bin:victim_race) |> 
  mutate(
    glm_results = map(data, glm_function)
  ) |> 
  unnest(glm_results) |> 
  select(city_state, odds_ratio, conf_lower_95, conf_upper_95)

homicide_plot = 
  homicide_glm |> 
  ggplot(aes(x = reorder(city_state, odds_ratio), y = odds_ratio)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf_lower_95, ymax = conf_upper_95)) 

print(homicide_plot)
```

## Problem 3
```{r}
bwt_df = 
  read_csv("data/birthweight.csv") |> 
  janitor::clean_names() |>
  mutate(
    babysex = as.factor(babysex),
    babysex = fct_recode(babysex, "male" = "1", "female" = "2"),
    frace = as.factor(frace),
    frace = fct_recode(
      frace, "white" = "1", "black" = "2", "asian" = "3", 
      "puerto rican" = "4", "other" = "8"),
    malform = as.logical(malform),
    mrace = as.factor(mrace),
    mrace = fct_recode(
      mrace, "white" = "1", "black" = "2", "asian" = "3", 
      "puerto rican" = "4"))
```
My hypothesis is that biological factors are more likely to underly birthweight, specifically `babysex`, `bhead`, `blength`, `gaweeks`, `malform`, `menarche`, `frace`, `mrace`, `ppbmi`, `ppwt`, `smoken`.

I will first fit MLR with these variables as predictors.
```{r}
linear_model = lm(bwt ~ babysex + bhead + blength + gaweeks + malform + menarche + frace + mrace + ppbmi + ppwt + smoken, data = bwt_df)
summary(linear_model)
```

Diagnostics for MLR:
```{r}
cor(bwt_df[, c("bhead", "blength", "gaweeks", "menarche", "ppbmi", "ppwt", "smoken")])

library(car)
vif(linear_model)
crPlots(linear_model)

```

I used the function `cor` to check for pairwise collinearity between numeric predictors. I found that there are no instances where correlation is larger than 0.8 or smaller than -0.8, which is typically the threshold to determine pairwise collinearity. However, the correlation for `blength` and `bhead` is approximately 0.63, which is not high enough to meet the threshold but worth mentioning. 

I also used `vif` to calculate VIFs for all predictors, including factor and logical variables (`mrace`, `frace`, `malform`). I found that VIFs for `frace` and `mrace` are 475 and 480, respectively.

I will fit another MLR keeping these findings in mind. 
```{r}
linear_model = lm(bwt ~ bhead * blength * gaweeks * menarche * ppbmi * ppwt * smoken * mrace * frace, data = bwt_df)
summary(linear_model)
```


```{r}
bwt_plot = 
  bwt_df |> 
  add_predictions(linear_model) |> 
  add_residuals(linear_model) |> 
  ggplot(aes(x = pred, y = resid)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE,  color = "red")

print(bwt_plot)

```

Compare with other models 
 
```{r}
model1 = lm(bwt ~ blength + gaweeks, data = birthweight_df)
summary(model1)
model2 = lm(bwt ~ bhead * blength * babysex, data = birthweight_df)
summary(model2)

```

